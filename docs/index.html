<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Crystal Docs 1.10.1">
<meta name="crystal_docs.project_version" content="main-dev">
<meta name="crystal_docs.project_name" content="conveyor">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="conveyor">
  <title>conveyor main-dev</title>
  <script type="text/javascript">
  CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill="currentColor" fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<input type="checkbox" id="sidebar-btn">
<label for="sidebar-btn" id="sidebar-btn-label">
  <svg class="open" xmlns="http://www.w3.org/2000/svg" height="2em" width="2em" viewBox="0 0 512 512"><title>Open Sidebar</title><path fill="currentColor" d="M80 96v64h352V96H80zm0 112v64h352v-64H80zm0 112v64h352v-64H80z"></path></svg>
  <svg class="close" xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 512 512"><title>Close Sidebar</title><path fill="currentColor" d="m118.6 73.4-45.2 45.2L210.7 256 73.4 393.4l45.2 45.2L256 301.3l137.4 137.3 45.2-45.2L301.3 256l137.3-137.4-45.2-45.2L256 210.7Z"></path></svg>
</label>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          conveyor
        </a>
      </h1>

      <span class="project-version">
        main-dev
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="conveyor/Conveyor" data-name="conveyor">
      <a href="Conveyor.html">Conveyor</a>
      
        <ul>
  
  <li class="parent " data-id="conveyor/Conveyor/Belt" data-name="conveyor::belt">
      <a href="Conveyor/Belt.html">Belt</a>
      
        <ul>
  
  <li class=" " data-id="conveyor/Conveyor/Belt/State" data-name="conveyor::belt::state">
      <a href="Conveyor/Belt/State.html">State</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="conveyor/Conveyor/Configuration" data-name="conveyor::configuration">
      <a href="Conveyor/Configuration.html">Configuration</a>
      
    </li>
  
  <li class=" " data-id="conveyor/Conveyor/Exception" data-name="conveyor::exception">
      <a href="Conveyor/Exception.html">Exception</a>
      
    </li>
  
  <li class="parent " data-id="conveyor/Conveyor/Job" data-name="conveyor::job">
      <a href="Conveyor/Job.html">Job</a>
      
        <ul>
  
  <li class=" " data-id="conveyor/Conveyor/Job/Bogus" data-name="conveyor::job::bogus">
      <a href="Conveyor/Job/Bogus.html">Bogus</a>
      
    </li>
  
  <li class=" " data-id="conveyor/Conveyor/Job/Bogus2" data-name="conveyor::job::bogus2">
      <a href="Conveyor/Job/Bogus2.html">Bogus2</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="conveyor/Conveyor/JobData" data-name="conveyor::jobdata">
      <a href="Conveyor/JobData.html">JobData</a>
      
    </li>
  
  <li class=" " data-id="conveyor/Conveyor/NoBelts" data-name="conveyor::nobelts">
      <a href="Conveyor/NoBelts.html">NoBelts</a>
      
    </li>
  
  <li class=" " data-id="conveyor/Conveyor/Orchestrator" data-name="conveyor::orchestrator">
      <a href="Conveyor/Orchestrator.html">Orchestrator</a>
      
    </li>
  
  <li class="parent " data-id="conveyor/Conveyor/Scheduler" data-name="conveyor::scheduler">
      <a href="Conveyor/Scheduler.html">Scheduler</a>
      
        <ul>
  
  <li class=" " data-id="conveyor/Conveyor/Scheduler/ScheduledJob" data-name="conveyor::scheduler::scheduledjob">
      <a href="Conveyor/Scheduler/ScheduledJob.html">ScheduledJob</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="conveyor/Conveyor/UnknownJobType" data-name="conveyor::unknownjobtype">
      <a href="Conveyor/UnknownJobType.html">UnknownJobType</a>
      
    </li>
  
  <li class="parent " data-id="conveyor/Conveyor/Web" data-name="conveyor::web">
      <a href="Conveyor/Web.html">Web</a>
      
        <ul>
  
  <li class=" " data-id="conveyor/Conveyor/Web/Component" data-name="conveyor::web::component">
      <a href="Conveyor/Web/Component.html">Component</a>
      
    </li>
  
  <li class=" " data-id="conveyor/Conveyor/Web/Form" data-name="conveyor::web::form(t)">
      <a href="Conveyor/Web/Form.html">Form</a>
      
    </li>
  
  <li class=" " data-id="conveyor/Conveyor/Web/JobsTable" data-name="conveyor::web::jobstable(t)">
      <a href="Conveyor/Web/JobsTable.html">JobsTable</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1><a id="conveyor" class="anchor" href="#conveyor">  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>conveyor</h1>
<p>Conveyor is a Crystal background-job framework, allowing you to offload work to other processes. This is useful for things like sending emails in web applications to avoid blocking the response while guaranteeing that the email is sent.</p>
<h2><a id="installation" class="anchor" href="#installation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Installation</h2>
<ol>
<li>
<p>Add the dependency to your <code>shard.yml</code>:</p>
<pre><code class="language-yaml">dependencies:
  conveyor:
    github: jgaskins/conveyor</code></pre>
</li>
<li>
<p>Run <code>shards install</code></p>
</li>
</ol>
<h2><a id="usage" class="anchor" href="#usage">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Usage</h2>
<p>In your Conveyor configuration file (for example, in <code>src/config/conveyor.cr</code>):</p>
<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;conveyor&quot;</span>
<span class="k">require</span> <span class="s">&quot;redis&quot;</span>

<span class="t">Conveyor</span>.configure <span class="k">do</span> <span class="o">|</span>c<span class="o">|</span>
  <span class="c"># The Redis client to use to store and retrieve your Conveyor jobs. Can also</span>
  <span class="c"># be specified via the `REDIS_URL` env var. Either this option or the env var</span>
  <span class="c"># must be provided.</span>
  c.redis <span class="o">=</span> <span class="t">Redis</span><span class="t">::</span><span class="t">Client</span>.new(<span class="t">URI</span>.parse(<span class="s">&quot;redis:///?max_idle_pool_size=10&quot;</span>))

  <span class="c"># How many concurrent workers the Conveyor orchestrator should start. Can be</span>
  <span class="c"># set via CONVEYOR_CONCURRENCY env var, defaults to 10.</span>
  c.concurrency <span class="o">=</span> <span class="n">10</span>

  <span class="c"># Set your queues in priority order, defaults to the CONVEYOR_QUEUES env var</span>
  <span class="c"># holding comma-separated queue names. If that is unspecified, it only</span>
  <span class="c"># consumes the &quot;default&quot; queue.</span>
  c.queues <span class="o">=</span> <span class="s">%w[critical high default low]</span>
<span class="k">end</span></code></pre>
<h3><a id="enqueuing-jobs" class="anchor" href="#enqueuing-jobs">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Enqueuing jobs</h3>
<p>Jobs are <code>struct</code>s that inherit <code><a href="Conveyor/Job.html">Conveyor::Job</a></code> with a <code>call</code> method. All instance variables of a job must be serializable back and forth to JSON.</p>
<pre><code class="language-crystal"><span class="k">struct</span> <span class="t">ExampleJob</span> <span class="o">&lt;</span> <span class="t">Conveyor</span><span class="t">::</span><span class="t">Job</span>
  <span class="k">def</span> <span class="m">initialize</span>(@name : <span class="t">String</span>)
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">call</span>
    <span class="c"># Do some work</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
<p>To enqueue this job, call <code>enqueue</code> on an instance of it:</p>
<pre><code class="language-crystal"><span class="t">ExampleJob</span>.new(name: <span class="s">&quot;Foo&quot;</span>).enqueue</code></pre>
<h3><a id="scheduling-jobs" class="anchor" href="#scheduling-jobs">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Scheduling jobs</h3>
<p>To schedule the job to run at a later time, you can specify <code>in</code> or <code>at</code> arguments:</p>
<pre><code class="language-crystal"><span class="t">ExampleJob</span>.new(name: <span class="s">&quot;Time::Span&quot;</span>).schedule <span class="k">in</span>: <span class="n">1</span>.minute
<span class="t">ExampleJob</span>.new(name: <span class="s">&quot;Time&quot;</span>).schedule at: <span class="n">5</span>.minutes.from_now</code></pre>
<h3><a id="recurring-jobs" class="anchor" href="#recurring-jobs">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Recurring jobs</h3>
<p>Recurring jobs can be scheduled on the orchestrator:</p>
<pre><code class="language-crystal"><span class="k">struct</span> <span class="t">MyDailyJob</span> <span class="o">&lt;</span> <span class="t">Conveyor</span><span class="t">::</span><span class="t">Job</span>
  <span class="k">def</span> <span class="m">call</span>
    <span class="c"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="t">Conveyor</span>.orchestrator.schedule <span class="k">do</span> <span class="o">|</span>schedule<span class="o">|</span>
  schedule.daily <span class="t">MyDailyJob</span>.new, at: <span class="s">&quot;06:15&quot;</span>, <span class="k">in</span>: <span class="t">Time</span><span class="t">::</span><span class="t">Location</span><span class="t">::</span><span class="t">UTC</span>
  schedule.every <span class="n">30</span>.seconds, <span class="t">Poll</span>
<span class="k">end</span></code></pre>
<p>Multiple instances of your workers will coordinate so you won't get multiple instances of each one.</p>
<h2><a id="setting-queue" class="anchor" href="#setting-queue">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Setting queue</h2>
<p>To set a job's default queue, define a <code>queue</code> method on it. If you don't specify one, it will be <code>&quot;default&quot;</code>.</p>
<pre><code class="language-crystal"><span class="k">struct</span> <span class="t">ExampleJob</span> <span class="o">&lt;</span> <span class="t">Conveyor</span><span class="t">::</span><span class="t">Job</span>
  <span class="c"># ...</span>

  <span class="k">def</span> <span class="m">queue</span>
    <span class="s">&quot;low&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
<p>To enqueue a specific job on a different queue from the one its type defaults to (for example, to give specific invocations higher priority), you can pass a <code>queue</code> argument to <code>enqueue</code>:</p>
<pre><code class="language-crystal"><span class="t">ExampleJob</span>.new(name: <span class="s">&quot;Foo&quot;</span>).enqueue queue: <span class="s">&quot;high&quot;</span></code></pre>
<h3><a id="processing-jobs" class="anchor" href="#processing-jobs">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Processing jobs</h3>
<p>In some job processors written in languages like Ruby that can load code at runtime, you might run a CLI provided by the framework to process jobs. Since Crystal doesn't allow runtime code loading, you need to write that yourself:</p>
<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;./config/conveyor&quot;</span>
<span class="k">require</span> <span class="s">&quot;./jobs/**&quot;</span>

<span class="c"># Make sure you set up the orchestrator to shut down cleanly when your shutdown</span>
<span class="c"># criteria are met. In this example, we&#39;re using TERM and INT signals to notify</span>
<span class="c"># the background job workers to shut down.</span>
[
  <span class="t">Signal</span><span class="t">::</span><span class="t">TERM</span>,
  <span class="t">Signal</span><span class="t">::</span><span class="t">INT</span>,
].each <span class="o">&amp;</span>.trap { <span class="t">Conveyor</span>.orchestrator.stop }

<span class="t">Conveyor</span>.orchestrator.start</code></pre>
<h2><a id="development" class="anchor" href="#development">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Development</h2>
<p>idk i'm still figuring this out tbh</p>
<h2><a id="contributing" class="anchor" href="#contributing">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributing</h2>
<ol>
<li>Fork it (<a href="https://github.com/jgaskins/conveyor/fork">https://github.com/jgaskins/conveyor/fork</a>)</li>
<li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li>
<li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li>
<li>Push to the branch (<code>git push origin my-new-feature</code>)</li>
<li>Create a new Pull Request</li>
</ol>
<h2><a id="contributors" class="anchor" href="#contributors">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributors</h2>
<ul>
<li><a href="https://github.com/jgaskins">Jamie Gaskins</a> - creator and maintainer</li>
</ul>
</div>
</body>
</html>
